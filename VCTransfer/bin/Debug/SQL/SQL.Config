<?xml version="1.0" encoding="utf-8" ?>
<SQLDefines>
  <SQL name="getProductList">
    SELECT DISTINCT Product.ProductId, Program_Product.PartNumber,Program_Product.Name from Product
    INNER JOIN dbo.Program_Product ON Program_Product.PartNumber = Product.PartNumber
    WHERE Product.PartNumber is not null
  </SQL>
  <SQL name="updateProductEstUnit">
    Update Product Set EstUnits={1},PHOnHand={2} Where ProductID={0}
  </SQL>
  <SQL name="getDownloadOrderList">

    update Address set stateid=state.StateId
    from Address
    inner join state on StateCode=state.Code
    where isnull(Address.StateId,0)=0


    Select DISTINCT
    o.orderid AS OrderId, o.AltOrderNum as AltOrderNum,
    1 AS release_num,
    a.[Company] AS b_company, a.address1 AS b_address1,
    a.[Address2] AS b_address2,
    a.[Address3] AS b_address3, a.[City] AS b_city, state.[Code] AS b_state, a.[PostalCode] AS b_zip,
    country.[ISO2] AS b_country,  c.[FirstName] AS B_FIRSTNAME, c.[LastName] AS B_LASTNAME, a.[PhoneNumber] AS b_phone,c.Email as b_email,

    da.[Company] AS d_company, da.address1 AS d_address1,
    da.[Address2] AS d_address2,
    da.[Address3] AS d_address3, da.[City] AS d_city, dstate.[Code] AS d_state, da.[PostalCode] AS d_zip,
    dcountry.[ISO2] AS d_country,  d.[FirstName] AS D_FIRSTNAME, d.[LastName] AS D_LASTNAME, da.[PhoneNumber] AS d_phone,d.Email as d_email,

    o.[OrderDate] AS date_ordered,
    c.[customerId] AS cust_id, o.[TotalOrderAmount] AS TotalOrderAmount,
    isnull(o.[TotalShipping],0) + isnull(o.[TotalHandling],0) AS TotalShipping,
    o.[TotalTax] AS TotalTax,Party.PartyCode
    from (
    select distinct o2.orderid, o2.altordernum, o2.programid, o2.ordertypeid, o2.customerid,
    o2.customeraddressid, o2.orderdate, o2.totaltax, o2.totalshipping,o2.ShipToAddressId,
    o2.totalhandling, o2.totalorderamount, o2.statuscode, o2.releasedate,o2.PartyId,o2.DesignerId
    from [order] o2 with (nolock)
    inner join order_line_item oli2 with (nolock) on o2.orderid = oli2.orderid
    where oli2.releasedate is null and oli2.ReleaseNumber is null  and o2.statuscode = 'AS'  and oli2.StatusCode is null
    ) o
    INNER JOIN customer   c with (nolock) ON o.[CustomerId] = c.[CustomerId]
    INNER JOIN address  a with (nolock) ON o.CustomerAddressId = a.[AddressId]
    LEFT JOIN [State] state  with (nolock)  ON a.[StateId] = state.[StateId]
    INNER JOIN country  country with (nolock) ON a.[CountryId] = country.[CountryId]

    INNER JOIN customer d WITH(NOLOCK) ON o.DesignerId=d.CustomerId
    LEFT JOIN address  da with (nolock) ON d.DefaultBillingAddressId = da.[AddressId]
    LEFT JOIN [State] dstate  with (nolock)  ON da.[StateId] = dstate.[StateId]
    LEFT JOIN country  dcountry with (nolock) ON da.[CountryId] = dcountry.[CountryId]

    LEFT JOIN dbo.Party ON Party.PartyId = o.PartyId
  </SQL>
  <SQL name="getOrderLineByOrderId">
    SELECT  distinct s.[Code] as ShipMethod,ShipCarrier.Code AS ShipCarrier,
    sa.AddressId as S_addressId,
    sa.[Company] AS s_company, sa.[Address1] AS s_address1, sa.[Address2] AS s_address2,
    sa.[Address3] AS s_address3, sa.[City] AS s_city, sstate.[Code] AS s_state, sa.[PostalCode] AS s_zip,
    scountry.[ISO2] AS s_country, sa.[LastName] as S_LastNAME, sa.[FirstName] AS S_FIRSTNAME,
    sa.[PhoneNumber]  AS s_phone,sc.email as s_email,
    oli.[LineNum] AS order_line, oli.[PartNumber] AS PartNumber,  oli.[Quantity] AS Quantity,
    oli.[ActualPrice] AS price, Product.Phantom
    FROM order_line_item oli
    INNER JOIN customer  sc with (nolock)  ON oli.[ShipToCustomerId] = sc.[CustomerId]
    INNER JOIN address sa with (nolock)  ON oli.[ShipToAddressId] = sa.[AddressId]
    INNER JOIN state  sstate with (nolock)  ON sa.[StateId] = sstate.[StateId]
    INNER JOIN country scountry with (nolock)  ON sa.[CountryId] = scountry.[CountryId]
    INNER JOIN [ShipMethod]  s with (nolock)  ON oli.[ShipMethodId] = s.[ShipMethodId]
    INNER JOIN dbo.ShipCarrier ON ShipCarrier.ShipCarrierId = s.ShipCarrierId
    inner join Product on Product.PartNumber=oli.PartNumber
    WHERE (oli.statuscode  &lt;&gt;'cn' or oli.statuscode is null) and oli.releasedate is null  and oli.ReleaseNumber  is null
    and oli.orderId={0} 
    ORDER BY sa.AddressId

  </SQL>
  <SQL name="ReleaseOrderLineByOrderId">
    UPDATE dbo.Order_Line_Item SET ReleaseNumber=1,ReleaseDate=GETDATE(),StatusCode='WH' WHERE OrderId={0} and StatusCode is null and ReleaseDate is null
  </SQL>
  <SQL name="getShimentOrderList">
    SELECT DISTINCT [Order].* FROM [dbo].[Order]
    INNER JOIN dbo.Order_Line_Item ON Order_Line_Item.OrderId = [Order].OrderId
    WHERE Order_Line_Item.StatusCode='WH' or  Order_Line_Item.StatusCode='BO'
    --WHERE  [Order].OrderID=25008980
  </SQL>
  <SQL name="updateOrderLineItemShipment">
    Update Order_Line_Item
    set StatusCode = 'SH', ShippedDate = '{2}',
    TrackingNumber = '{3}',qtyshipped =Quantity,
    qtyshipnotinv = Quantity
    where orderid={0} and PartNumber='{1}'
  </SQL>
  <SQL name="getOrderReleaseByOrderId">
    SELECT TrackingNumber,ShippedDate FROM dbo.Order_Line_Item WHERE StatusCode='SH' AND OrderId={0}
    GROUP BY TrackingNumber,ShippedDate
  </SQL>
  <SQL name="updateOrderStatusSH">

    ;WITH t1 AS (
    SELECT DISTINCT o.orderid,oli.quantity,oli.qtyshipped  From [order] o with (nolock)
    inner join order_line_item oli with (nolock)
    on o.orderid = oli.orderid
    where (o.statuscode = 'AS' or o.statuscode = 'ER') and oli.statuscode NOT IN  ('cn','si')
    and NOT EXISTS (SELECT * FROM order_line_item  with(nolock)
    WHERE orderid=o.orderid AND  statuscode = 'PK')
    and o.orderid not in
    (select distinct o.orderid From [order] o with(nolock)
    inner join order_line_item oli with (nolock)
    on o.orderid = oli.orderid
    where o.statuscode = 'AS' and oli.statuscode is null)
    )
    SELECT orderid INTO #order
    FROM t1
    group by orderid
    having sum(isnull(quantity,0)) = sum(isnull(qtyshipped,0))
    OPTION(LOOP JOIN)

    update [order]
    set statuscode = 'SH'
    FROM [order] INNER JOIN #order ON [order].orderid=#order.orderid

    DROP TABLE #order


  </SQL>
  <SQL name="createASN">
    insert into Order_Line_Shipment_ASN(ORDER_ID,RELEASE_NUM,ORDER_LINE,CARTON_ID_FROM,ITEM_ID,PIECES_TO_MOVE)
    select OrderId,{1},LineNum,{1},PartNumber,Quantity
    from Order_Line_Item
    where Order_Line_Item.OrderId={0} AND dbo.Order_Line_Item.ReleaseNumber={1}
  </SQL>
  <SQL name="getOrderExpectedShipDate">
    SELECT [dbo].[udf_getExpectedShippingDate]({0},'{1}','{2}') as ExpectedShipDate
  </SQL>
  <SQL name="updateOrderExpectedShipDate">
    Update [Order] set expectedShipDate='{1}' where orderId={0}
  </SQL>
  <SQL name="UpdateBOOrder">

    UPDATE oli
    SET    statuscode = 'BO'
    FROM order_line_item oli
    INNER JOIN [order] o
    ON oli.orderid = o.orderid
    INNER JOIN product pp
    ON pp.partnumber = oli.partnumber
    WHERE
    oli.statuscode = 'WH'
    AND isnull(pp.Phantom,0)=0
    AND ISNULL(pp.phonhand,0) - ISNULL(pp.phonhold,0) - ISNULL(pp.phblocked,0) &lt;= 0
  </SQL>
  
  
  <SQL name="getOrderById">
    SELECT top 1 oli.shippeddate, oli.TrackingNumber,o.*,OC.LastName,OC.firstName,oc.email,shipmethod.Name as SHName,ShipCarrier.TrackingURL,shipmethod.Name as ShipMethodName,ShipCarrier.Name as ShipCarrier
    FROM [Order] O  with (nolock)
    inner join Order_Line_Item oli with (nolock) on oli.orderid=o.orderid
    inner join shipmethod  with (nolock)  on shipmethod.shipmethodId=oli.shipmethodId
    inner join ShipCarrier on ShipCarrier.ShipCarrierId=shipmethod.ShipCarrierId
    LEFT OUTER JOIN Customer AS OC  with (nolock)  ON O.CustomerId = OC.CustomerId
    where O.orderId= {0} and  oli.shippeddate is not null
  </SQL>
  <SQL name="getEmailTemplate">
    SELECT *
    FROM Program_Email
    INNER JOIN [Type] ON EmailTypeId=TypeId AND Code='{0}'
  </SQL>
  <SQL name="getOrderDetailsByOrderId">
    SELECT Address1 as ShipToAddress,City as ShipToCity,PostalCode as ShipToZip,Address.StateCode as ShipToState,
    Order_Line_Item.*
    FROM Order_Line_Item
    inner join Address  ON AddressId=Order_Line_Item.ShipToAddressId
    Where OrderId={0} and ReleaseNumber={1}
  </SQL>
  <SQL name="updateOrderReleaseByTracking">
    UPDATE dbo.Order_Line_Item SET ReleaseNumber={2} WHERE OrderId={0} AND TrackingNumber='{1}'
  </SQL>
  <SQL name="deleteOrderLineShipmentCartonByOrderID">
    Delete Order_Line_Shipment_Carton Where ORDER_ID={0}
  </SQL>
  <SQL name="deleteOrderLineShipmentASNByOrderID">
    Delete Order_Line_Shipment_ASN Where ORDER_ID={0}
  </SQL>
  <SQL name="getEmailLog">
    SELECT * FROM dbo.App_Log_Mail WHERE oid='{0}' AND releaseid={1} AND Success=1 AND Type='ShippingConfirm'
  </SQL>
  <SQL name="getOrderForZoytoPH">

    Select distinct o.TotalWholeSaleAmount as Order_Product_Total
    ,O.TotalDiscountAmount-O.TotalMarkupAmount as Order_Discount
    ,O.TotalTax as Order_Tax,o.TotalShipping as Order_Shipping
    ,o.TotalHandling as Order_Handling,o.TotalOrderAmount as Order_Total,
    Program.ProgramId,Program.Name as Program_Name,
    o.OrderId,customer.firstname as B_FirstName,customer.lastname as B_LastName,
    c2.firstname as S_FirstName,c2.lastname as S_LastName,c2.AltCustNum as Order_Alt_Customer,oli.linenum as Line_Number,oli.OrderLineItemId
    ,source.code as Order_Source,shipmethod.Code as Shippng_Method_Code,shipmethod.Description as Shiping_Method
    ,ShipCarrier.Code as Shipper,oli.PartNumber
    ,oli.ProductName as Description,oli.quantity as Pieces_Ordered,oli.Price as Unit_Cost,oli.IsCommissionable,oli.ActualPrice,
    (Select KeyValue From Order_Info
    --  inner join Field on Field.FieldId=Order_Info.FieldId
    where KeyName='Order_ITN_Required' and OrderId={0}) as Order_ITN_Required,
    Address.Address1 as B_Address1,Address.Address2 as B_Address2,Address.City as B_City,State.Code as B_State,Address.PostalCode as B_Zip,Country.name as B_Country,Address.PhoneNumber as B_Phone,
    a2.Address1 as S_Address1,a2.Address2 as S_Address2,a2.City as S_City,s2.Code as S_State,a2.PostalCode as S_Zip,t2.name  as S_Country,a2.PhoneNumber as S_Phone,
    customer.company as B_Company,c2.company as s_Company,
    Program_Product.IsRMAable as Return_Expected,
    Deliver_Term= (
    select case when exists(select top 1 * from Order_Info
    inner join Field on Field.FieldId=Order_Info.FieldId
    where OrderId={0} and Field.[Name]='TradeTermsCode')
    then (select top 1 KeyValue from Order_Info
    inner join Field on Field.FieldId=Order_Info.FieldId
    where OrderId={0} and Field.[Name]='TradeTermsCode')
    else ' DDP' end),oli.ParentLineNum as Parent_Line_Number,o.OrderDate
    From [order] o  with (nolock)
    inner join Program with (nolock) on Program.ProgramId=o.ProgramId
    inner join customer with (nolock) on customer.customerId=o.customerId
    inner join Order_Line_Item oli with (nolock)  on oli.orderId=o.orderId
    inner join customer c2 with (nolock)  on c2.customerId=oli.shiptocustomerId
    inner join source with (nolock) on  source.sourceid=o.sourceid
    inner join shipmethod with (nolock) on shipmethod.shipmethodId=oli.shipmethodId
    inner join ShipCarrier with (nolock) on shipmethod.ShipCarrierId=ShipCarrier.ShipCarrierId
    INNER join Address with (nolock) on Address.AddressId=o.CustomerAddressId
    INNER join Address a2 with (nolock) on a2.AddressId=oli.ShipToAddressId
    inner join State with (nolock) on State.StateId=Address.StateId
    inner join State s2 with (nolock) on s2.StateId=a2.StateId
    inner join Country with (nolock) on Country.CountryId=Address.CountryId
    inner join Country t2 with (nolock) on t2.CountryId=a2.CountryId
    inner join Product  with (nolock) on Product.PartNumber=oli.PartNumber
    inner join Program_Product  with (nolock) on Program_Product.PartNumber=oli.PartNumber and Program_Product.programId=o.ProgramId
    Where o.orderid={0} 
    order by oli.linenum


  </SQL>
  <SQL name="resetProductEstcommitted">
    update Product set EstCommitted=0
    where ISNULL(Product.Phantom,0)=0

    update Product set EstCommitted=o.quantity
    from Product
    inner join (
    SELECT oli.partnumber,sum(quantity) as quantity from Order_Line_Item oli with(nolock)
    INNER JOIN [order] o ON o.orderid = oli.orderid
    where oli.statuscode is null and oli.releasenumber is null and partnumber is not null
    group by oli.partnumber ) o on o.partnumber=Product.partnumber
    where ISNULL(Product.Phantom,0)=0

    update product     set estunits = 0     where estunits  &lt; 0
    update product     set estcommitted = 0     where estcommitted  &lt; 0
  </SQL>
  <SQL name="updateOrderPhontomOrderStatus">
    update a set a.statuscode='SH',qtyshipped=Quantity,qtyshipnotinv=Quantity,ShippedDate='{1}'
    from [order_line_item] a  inner join product b on a.partNumber=b.partNumber
    where a.orderid={0} and b.Phantom=1 and
    (not EXISTS (
    select top 1 *
    from [order_line_item] c  inner join product d on c.partNumber=d.partNumber
    where c.orderid={0} and d.Phantom=0 and (c.statuscode &lt;&gt; 'cn' and c.statuscode &lt;&gt;'sh')))
    and '{2}'='{2}'
  </SQL>
  <SQL name="updateDMShipingInfo">
    update DM_Order_Detail with (rowlock) set ShipDate='{2}' ,ShipTracking='{3}' where OrderID={0} and PartNumber='{1}'

    UPDATE
    o1 SET o1.ShipDate=o2.[ShipDate] , o1.[ShipTracking]=o2.[ShipTracking]
    FROM
    [DM_Order_Detail] o1
    INNER
    JOIN (SELECT DISTINCT ShipDate,ShipTracking,orderid,Parent_Line_Number FROM DM_Order_Detail WITH(NOLOCK)
    WHERE [Parent_Line_Number] IS not NULL ) o2 ON o1.orderid=o2.orderid AND o2.Parent_Line_Number=o1.line_number
    WHERE
    o1.[Parent_Line_Number] IS NULL
    AND
    o2.[ShipDate] IS NOT NULL AND o2.ShipTracking IS NOT null
    AND
    (o1.[ShipDate] IS NULL OR o1.[ShipTracking] IS NULL)

    AND o1.orderid={0}
  </SQL>
  


  <SQL name="getDownloadOrderListTF">
    Select DISTINCT
    o.orderid AS orderid,
    a.[Company] AS b_company, a.address1 AS b_address1,
    a.[Address2] AS b_address2,
    a.[Address3] AS b_address3, a.[City] AS b_city, state.[Code] AS b_state, a.[PostalCode] AS b_zip,
    country.[ISO2] AS b_country,  a.[LastName] AS b_lastname, a.[FirstName] AS b_firstname, a.[PhoneNumber] AS b_phone,c.Email as b_email,

    da.[Company] AS d_company, da.address1 AS d_address1,
    da.[Address2] AS d_address2,
    da.[Address3] AS d_address3, da.[City] AS d_city, dstate.[Code] AS d_state, da.[PostalCode] AS d_zip,
    dcountry.[ISO2] AS d_country,  d.[FirstName] AS D_FIRSTNAME, d.[LastName] AS D_LASTNAME, da.[PhoneNumber] AS d_phone,d.Email as d_email,


    o.[OrderDate] AS date_ordered,
    c.[customerId] AS cust_id, o.[TotalOrderAmount] AS total_value,
    isnull(o.[TotalShipping],0) + isnull(o.[TotalHandling],0) AS shipping_charge,
    o.[TotalTax] AS handling_charge, o.programid as group1
    ,Left(ltrim(Convert(varchar(10),o.OrderId))+' '+Program.SourceKey,25) as or_cust1,po_num,altordernum
    from (
    select distinct o2.orderid, o2.altordernum, o2.programid, o2.ordertypeid, o2.customerid,
    o2.customeraddressid, o2.orderdate, o2.totaltax, o2.totalshipping,
    o2.totalhandling, o2.totalorderamount, o2.statuscode, o2.releasedate,o2.PONumber as po_num,PWPCustomerId
    from [order] o2 with (nolock)
    inner join order_line_item oli2 with (nolock) on o2.orderid = oli2.orderid
    where oli2.releasedate is null and oli2.ReleaseNumber is null  and o2.statuscode = 'AS' and (o2.[Route]='Zoyto' OR o2.[Route] is null)
    ) o
    INNER JOIN customer   c with (nolock) ON o.[CustomerId] = c.[CustomerId]
    INNER JOIN address  a with (nolock) ON o.[CustomerAddressId] = a.[AddressId]
    INNER JOIN [State] state  with (nolock)  ON a.[StateId] = state.[StateId]
    INNER JOIN country  country with (nolock) ON a.[CountryId] = country.[CountryId]
    inner join Program with (nolock) on Program.ProgramId=o.ProgramId

    INNER JOIN customer d WITH(NOLOCK) ON o.PWPCustomerId=d.CustomerId
    LEFT JOIN address  da with (nolock) ON d.BillToAddressId = da.[AddressId]
    LEFT JOIN [State] dstate  with (nolock)  ON da.[StateId] = dstate.[StateId]
    LEFT JOIN country  dcountry with (nolock) ON da.[CountryId] = dcountry.[CountryId]

  </SQL>
  <SQL name="getOrderTFById">
    Select * from [order] (nolock) where orderid={0}
  </SQL>
  <SQL name="getUserById">
    SELECT *
    FROM [User] WITH(NOLOCK) WHERE UserId={0}
  </SQL>
  <SQL name="getPaymentTermsById">
    SELECT * FROM PaymentTerms Where Id={0}
  </SQL>
  <SQL name="getPaymentArrangementListByOrderId">
    SELECT *
    FROM PaymentArrangement
    Where OrderId={0}
  </SQL>
  <SQL name="getTFOrderPaymentArrangementList">
    SELECT *
    FROM PaymentArrangement
    Where OrderId={0} and isnull(InvoiceId,0)=0
  </SQL>
  <SQL name="getTotalInvoiceLineItemByInvoiceId">
    select sum(Invoice_Line_Item.amount) as amount from Invoice_Line_Item (nolock)
    inner join order_line_item  (nolock) on order_line_item.orderlineitemid=Invoice_Line_Item.orderlineitemid
    where Invoice_Line_Item.invoiceid={0}
  </SQL>
  <SQL name="getInvoice">
    SELECT * FROM Invoice Where OrderId={0} 
  </SQL>
  <SQL name="getInvoiceByOrderId">
    select top 1 Invoice_Line_Item.* from Invoice_Line_Item
    inner join order_line_item on order_line_item.orderlineitemid=Invoice_Line_Item.orderlineitemid
    where order_line_item.orderid={0} and order_line_item.releasenumber={1}
  </SQL>
  <SQL name="getInvoiceList">
    SELECT *
    FROM Invoice
    Where EmailSentOn is null
  </SQL>
  <SQL name="getCustomerById">
    SELECT Customer.*,salerep.email as SalesRepEmail FROM Customer
    inner join [user] salerep (nolock) on customer.SalesRepId=salerep.userid
    Where CustomerID={0}
  </SQL>
  <SQL name="getCustomerByInvoiceId">
    select customer.*,salerep.email as SalesRepEmail from customer (nolock)
    inner join invoice (nolock) on invoice.customerid=customer.customerid
    inner join [user] salerep (nolock) on customer.SalesRepId=salerep.userid
    where invoice.invoiceid={0}
  </SQL>
  <SQL name="getOrderLineByOrderPartNumber">
    SELECT * FROM dbo.Order_Line_Item WHERE OrderId={0} AND PartNumber='{1}' and Quantity={2}
  </SQL>
  <SQL name="getInvoiceById">
    SELECT I.* ,S.[Description] AS StatusName
    FROM Invoice I WITH(NOLOCK)
    LEFT JOIN [Status] S WITH(NOLOCK) ON I.PaymentStatus = S.Code AND S.GroupBy = 'Payment'
    WHERE I.InvoiceId={0}
  </SQL>
  <SQL name="getAddressById">
    select * from Address WITH (NOLOCK) where AddressId={0}
  </SQL>
  <SQL name="getInvoice_Line_ItemListByInvoiceId">
    SELECT [Invoice_Line_Item].*,Order_Line_Item.StandardPrice,
    (Order_Line_Item.StandardPrice-[Invoice_Line_Item].Price)*[Invoice_Line_Item].Quantity as DiscountAmount
    ,[Invoice_Line_Item].Price as WholeSalePrice
    ,[Invoice_Line_Item].amount AS TotalCost
    FROM [Invoice_Line_Item] WITH(NOLOCK)
    INNER JOIN Order_Line_Item WITH(NOLOCK) ON [Invoice_Line_Item].OrderLineItemId=Order_Line_Item.OrderLineItemId
    WHERE [Invoice_Line_Item].InvoiceId = {0} AND Order_Line_Item.StatusCode = 'SH'
  </SQL>
  <SQL name="getShipMethodById">
    select   * from ShipMethod   Where ShipMethodId={0}
  </SQL>
  <SQL name="getOrderLineItemsByOrderId">
    select   * from Order_Line_Item   Where OrderID={0}
  </SQL>
  <SQL name="getShipDiscount">
    SELECT sum(CouponShippingDiscount) as DiscountAmount
    FROM [Order_line_item] WITH(NOLOCK) WHERE orderid={0}
  </SQL>



  <SQL name="getOrderDownNU">
    Select distinct
    o.orderid , o.AltOrderNum,
    1 AS release_num, c.[Company] AS b_company, a.address1 AS b_address1,
    a.[Address2] AS b_address2,
    a.[Address3] AS b_address3, a.[City] AS b_city, state.[Code] AS b_state, a.[PostalCode] AS b_zip,
    country.[ISO2] AS b_country,
    (case isnull(a.[FirstName] ,'') when '' then c.[FirstName] else a.[FirstName] end ) as b_FirstName,
    (case isnull(a.[LastName] ,'') when '' then c.[LastName] else a.[LastName] end ) as b_LastName,
    Phone.[Number] AS b_phone,c.Email AS b_email,
    o.[OrderDate] AS date_ordered,
    c.[customerId] AS cust_id, o.[TotalOrderAmount] AS total_value,
    isnull(o.[TotalShipping],0) + isnull(o.[TotalHandling],0) AS shipping_charge,
    o.[TotalTax] AS handling_charge, o.programid as group1,t.code as group2,o.OrderTypeId,o.ForceReDownload
    ,Left(ltrim(Convert(varchar(10),o.OrderId))+' '+Program.SourceKey,25) as or_cust1,o.ExpectedShipDate as SHIP_BY_DATE
    ,t.code as ORDER_TYPE,c.AltCustNum
    from (
    select distinct o2.orderid, o2.altordernum, o2.programid, o2.ordertypeid, o2.customerid,
    o2.customeraddressid, o2.orderdate, o2.totaltax, o2.totalshipping,
    o2.totalhandling, o2.totalorderamount, o2.statuscode,o2.ForceReDownload,
    ExpectedShipDate= case o2.ProgramId When 354 then o2.ExpectedShipDate else null end
    from [order] o2 with (nolock)
    inner join order_line_item oli2 with (nolock) on o2.orderid = oli2.orderid
    where oli2.releasedate is null and oli2.ReleaseNumber is null and o2.statuscode = 'AS'

    ) o
    left join Order_PaymentArrangement_Xref (nolock) on Order_PaymentArrangement_Xref.orderid=o.orderid
    left join PaymentArrangement (nolock) on PaymentArrangement.PaymentArrangementId=Order_PaymentArrangement_Xref.PaymentArrangementId
    left JOIN customer   c with (nolock) ON PaymentArrangement.BillToCustomerId = c.[CustomerId]
    left JOIN address  a with (nolock) ON PaymentArrangement.BillToAddressId = a.[AddressId]
    left JOIN [State] state  with (nolock)  ON a.[StateId] = state.[StateId]
    left JOIN country  country with (nolock) ON a.[CountryId] = country.[CountryId]
    left JOIN Phone  with (nolock) ON a.[PhoneId] = Phone.[PhoneId]
    inner join Program with (nolock) on Program.ProgramId=o.ProgramId
    inner join [Type] t with (nolock) on t.typeid=o.OrderTypeId
  </SQL>
  <SQL name="getOrderLineDownNU">
    SELECT distinct s.[Code] as ShipMethod,sa.AddressId as S_addressId,
    sc.[Company] AS s_company, sa.[Address1] AS s_address1, sa.[Address2] AS s_address2,
    sa.[Address3] AS s_address3, sa.[City] AS s_city, sstate.[Code] AS s_state, sa.[PostalCode] AS s_zip,
    scountry.[ISO2] AS s_country,sc.Email AS s_email,

    (case isnull(sa.[FirstName] ,'') when '' then  sc.[FirstName] else sa.[FirstName] end ) as s_FirstName,
    (case isnull(sa.[LastName] ,'') when '' then  sc.[LastName] else sa.[LastName] end ) as s_LastName,

    Phone.[Number]  AS s_phone,oli.shipmethodid,
    oli.[LineNum] AS order_line, oli.[PartNumber],  oli.[Quantity] AS pieces_ordered,
    (case isnull(oli.statuscode,'') when 'AS' then oli.[Quantity] when '' then oli.[Quantity] else 0  end) AS Quantity,
    oli.[ActualPrice] AS price, oli.[DiscountAmount] AS discount,oli.ParentLineNum,oli.LineNum,oli.OrderLineItemId,Product.Phantom,oli.INV_TYPE,
    product.name as ProductName
    FROM order_line_item oli
    INNER JOIN customer  sc with (nolock)  ON oli.[ShipToCustomerId] = sc.[CustomerId]
    INNER JOIN address sa with (nolock)  ON oli.[ShipToAddressId] = sa.[AddressId]
    INNER JOIN state  sstate with (nolock)  ON sa.[StateId] = sstate.[StateId]
    INNER JOIN country scountry with (nolock)  ON sa.[CountryId] = scountry.[CountryId]
    INNER JOIN [ShipMethod]  s with (nolock)  ON oli.[ShipMethodId] = s.[ShipMethodId]
    left JOIN Phone  with (nolock) ON sa.[PhoneId] = Phone.[PhoneId]
    inner join Product on Product.PartNumber=oli.PartNumber
    WHERE (oli.statuscode   &lt;&gt; 'cn' or oli.statuscode is null) and oli.releasedate is null and oli.ReleaseNumber  is null
    and oli.orderId={0}
    ORDER BY sa.AddressId, oli.shipmethodid,oli.[LineNum]

  </SQL>
  <SQL name="getOrderForZoytoPHNU">
    Select distinct o.TotalProductAmount as Order_Product_Total
    ,O.TotalDiscountAmount-O.TotalMarkupAmount as Order_Discount
    ,O.TotalTax as Order_Tax,o.TotalShipping as Order_Shipping
    ,o.TotalHandling as Order_Handling,o.TotalOrderAmount as Order_Total,
    Program.ProgramId,Program.Name as Program_Name,
    o.OrderId,
    --
    --customer.firstname as B_FirstName,
    --customer.lastname as B_LastName,
    --c2.firstname as S_FirstName,
    --c2.lastname as S_LastName,

    (case isnull(Address.[FirstName] ,'') when '' then customer.[FirstName]  else Address.[FirstName]   end) AS B_FirstName,
    (case isnull(Address.lastname ,'') when '' then customer.lastname  else Address.lastname   end)	AS B_LastName,
    (case isnull(a2.firstname ,'') when '' then c2.firstname  else a2.firstname   end)	AS S_FirstName,
    (case isnull(a2.lastname ,'') when '' then c2.lastname  else a2.lastname   end)	AS S_LastName,

    c2.AltCustNum as Order_Alt_Customer,oli.linenum as Line_Number,oli.OrderLineItemId
    ,source.code as Order_Source,shipmethod.Code as Shippng_Method_Code,shipmethod.Name as Shiping_Method
    ,ShipCarrier.Code as Shipper,oli.PartNumber
    ,oli.ProductName as Description,oli.quantity as Pieces_Ordered,oli.Price as Unit_Cost,oli.IsCommissionable,oli.ActualPrice,'false' as Order_ITN_Required,
    Address.Address1 as B_Address1,Address.Address2 as B_Address2,Address.City as B_City,State.Code as B_State,Address.PostalCode as B_Zip,Country.name as B_Country,Phone.Number as B_Phone,
    a2.Address1 as S_Address1,a2.Address2 as S_Address2,a2.City as S_City,s2.Code as S_State,a2.PostalCode as S_Zip,t2.name  as S_Country,p2.Number as S_Phone,
    customer.company as B_Company,c2.company as s_Company,o.OrderDate,oli.ShippedDate,oli.TrackingNumber as ShipTracking
    From [order] o  with (nolock)
    inner join Order_PaymentArrangement_Xref (nolock) on Order_PaymentArrangement_Xref.orderid=o.orderid
    inner join PaymentArrangement (nolock) on PaymentArrangement.PaymentArrangementId=Order_PaymentArrangement_Xref.PaymentArrangementId
    inner join Program with (nolock) on Program.ProgramId=o.ProgramId
    inner join customer with (nolock) on customer.customerId=o.customerId
    inner join Order_Line_Item oli with (nolock)  on oli.orderId=o.orderId
    inner join customer c2 with (nolock)  on c2.customerId=oli.shiptocustomerId
    inner join source with (nolock) on  source.sourceid=o.sourceid
    inner join shipmethod with (nolock) on shipmethod.shipmethodId=oli.shipmethodId
    inner join ShipCarrier with (nolock) on shipmethod.ShipCarrierId=ShipCarrier.ShipCarrierId
    INNER join Address with (nolock) on Address.AddressId=PaymentArrangement.BilltoAddressId
    INNER join Address a2 with (nolock) on a2.AddressId=oli.ShipToAddressId
    inner join State with (nolock) on State.StateId=Address.StateId
    inner join State s2 with (nolock) on s2.StateId=a2.StateId
    inner join Country with (nolock) on Country.CountryId=Address.CountryId
    inner join Country t2 with (nolock) on t2.CountryId=a2.CountryId
    inner join Phone  with (nolock) on Phone.PhoneId=Address.PhoneId
    inner join Phone p2 with (nolock) on p2.PhoneId=a2.PhoneId
    Where o.orderid={0} 
    order by oli.linenum

  </SQL>
  <SQL name="getOrderByIdNU">
    SELECT top 1 o.*,OC.LastName,OC.firstName,oc.email,shipmethod.Name as SHName,oli.shippeddate,oli.TrackingNumber,
    t.code as ordertype,shipmethod.Trackingurl,ShipCarrier.Name  as ShipCarrier,
    Address1 as ShipToAddress,City as ShipToCity,PostalCode as ShipToZip,state.Code as ShipToState
    FROM [Order] O  with (nolock)
    inner join Order_Line_Item oli with (nolock) on oli.orderid=o.orderid
    inner join shipmethod  with (nolock)  on shipmethod.shipmethodId=oli.shipmethodId
    inner join ShipCarrier  with (nolock)  on ShipCarrier.ShipCarrierId=shipmethod.ShipCarrierId
    LEFT OUTER JOIN Customer AS OC  with (nolock)  ON O.CustomerId = OC.CustomerId
    inner join type t with (nolock) on t.typeid=o.ordertypeid
    left join address (nolock) on address.addressid=oli.ShipToAddressId
    left join State (nolock) on address.Stateid=State.StateId
    where O.orderId= {0} and  oli.shippeddate is not null

  </SQL>
  <SQL name="getOrdersDetailNU">
    SELECT  O.AltOrderNum, O.ProgramId, OLI.PartNumber, OLI.ProductName, OLI.Quantity, ISNULL(OLI.Price,0) AS Price,
    OLI.ShipToCustomerId, O.CustomerId,O.OrderDate, OLI.ShippedDate, OLI.TrackingNumber, SH.Name AS SHName,
    SH.TrackingURL, O.OrderId, OC.Email, C.FirstName, C.LastName, C.Company, A.Address1, A.Address2, A.Address3,A.City,
    S.Code AS STATE, A.PostalCode,OLI.ReleaseNumber,oli.LineNum,O.OrderTypeId,status.Description as LineStatus
    FROM [Order] O
    INNER JOIN Order_Line_Item AS OLI ON O.OrderId = OLI.OrderId
    INNER JOIN ShipMethod AS SH ON OLI.ShipMethodId = SH.ShipMethodId
    LEFT OUTER JOIN Customer AS C ON OLI.ShipToCustomerId = C.CustomerId
    LEFT OUTER JOIN Address AS A ON OLI.ShipToAddressId = A.AddressId
    LEFT OUTER JOIN State AS S ON S.StateId = A.StateId
    LEFT OUTER JOIN Customer AS OC ON O.CustomerId = OC.CustomerId
    left join status on status.code=oli.statuscode
    where O.orderId={0}
  </SQL>
  <SQL name="getMailAddress">
    usp_StoreCommon_getSendEmailInfoByType @code='SHIP_CONFIRMATION',@group='Email',@customerid={0}
  </SQL>
  <SQL name="getOrderLineShipmentCartonByOrderID">
    select * FROM dbo.Order_Line_Shipment_Carton WHERE ORDER_ID={0} AND RELEASE_NUM={1}
  </SQL>
  <SQL name="getOrderLineShipmentASNByOrderID">
    select * FROM dbo.Order_Line_Shipment_ASN WHERE ORDER_ID={0} AND RELEASE_NUM=1
  </SQL>
  <SQL name="getReInvoiceEmailList">
    select * from Invoice where orderid=26419566
  </SQL>

  <SQL name="getOrderDownLenovo">
    Select DISTINCT
    o.orderid AS OrderId, o.AltOrderNum as AltOrderNum,
    1 AS release_num,
    a.[Company] AS b_company, a.address1 AS b_address1,
    a.[Address2] AS b_address2,
    a.[Address3] AS b_address3, a.[City] AS b_city, state.[Code] AS b_state, a.[PostalCode] AS b_zip,
    country.[ISO2] AS b_country,  c.[FirstName] AS B_FIRSTNAME, c.[LastName] AS B_LASTNAME, a.[PhoneNumber] AS b_phone,c.Email as b_email,

    o.[OrderDate] AS date_ordered,
    c.[customerId] AS cust_id, o.[TotalOrderAmount] AS TotalOrderAmount,
    isnull(o.[TotalShipping],0) + isnull(o.[TotalHandling],0) AS TotalShipping,
    o.[TotalTax] AS TotalTax
    from (
    select distinct o2.orderid, o2.altordernum, o2.programid, o2.ordertypeid, o2.customerid,
    o2.customeraddressid, o2.orderdate, o2.totaltax, o2.totalshipping,
    o2.totalhandling, o2.totalorderamount, o2.statuscode, o2.releasedate
    from [order] o2 with (nolock)
    inner join order_line_item oli2 with (nolock) on o2.orderid = oli2.orderid
    where oli2.releasedate is null and oli2.ReleaseNumber is null  and o2.statuscode = 'AS'  and oli2.StatusCode is null
    ) o
    INNER JOIN customer   c with (nolock) ON o.[CustomerId] = c.[CustomerId]
    INNER JOIN address  a with (nolock) ON o.CustomerAddressId = a.[AddressId]
    LEFT JOIN [State] state  with (nolock)  ON a.[StateId] = state.[StateId]
    INNER JOIN country  country with (nolock) ON a.[CountryId] = country.[CountryId]


  </SQL>
  <SQL name="getOrderForZoytoPHLenovo">

    Select distinct o.TotalProductAmount as Order_Product_Total
    ,O.TotalDiscountAmount-O.TotalMarkupAmount as Order_Discount
    ,O.TotalTax as Order_Tax,o.TotalShipping as Order_Shipping
    ,o.TotalHandling as Order_Handling,o.TotalOrderAmount as Order_Total,
    Program.ProgramId,Program.Name as Program_Name,
    o.OrderId,customer.firstname as B_FirstName,customer.lastname as B_LastName,
    c2.firstname as S_FirstName,c2.lastname as S_LastName,c2.AltCustNum as Order_Alt_Customer,oli.linenum as Line_Number,oli.OrderLineItemId
    ,source.code as Order_Source,shipmethod.Code as Shippng_Method_Code,shipmethod.Description as Shiping_Method
    ,ShipCarrier.Code as Shipper,oli.PartNumber
    ,oli.ProductName as Description,oli.quantity as Pieces_Ordered,oli.Price as Unit_Cost,oli.IsCommissionable,oli.ActualPrice,
    (Select KeyValue From Order_Info
    --  inner join Field on Field.FieldId=Order_Info.FieldId
    where KeyName='Order_ITN_Required' and OrderId={0}) as Order_ITN_Required,
    Address.Address1 as B_Address1,Address.Address2 as B_Address2,Address.City as B_City,State.Code as B_State,Address.PostalCode as B_Zip,Country.name as B_Country,Address.PhoneNumber as B_Phone,
    a2.Address1 as S_Address1,a2.Address2 as S_Address2,a2.City as S_City,s2.Code as S_State,a2.PostalCode as S_Zip,t2.name  as S_Country,a2.PhoneNumber as S_Phone,
    customer.company as B_Company,c2.company as s_Company,
    Program_Product.IsRMAable as Return_Expected,
    Deliver_Term= (
    select case when exists(select top 1 * from Order_Info
    inner join Field on Field.FieldId=Order_Info.FieldId
    where OrderId={0} and Field.[Name]='TradeTermsCode')
    then (select top 1 KeyValue from Order_Info
    inner join Field on Field.FieldId=Order_Info.FieldId
    where OrderId={0} and Field.[Name]='TradeTermsCode')
    else ' DDP' end),oli.ParentLineNum as Parent_Line_Number,o.OrderDate
    From [order] o  with (nolock)
    inner join Program with (nolock) on Program.ProgramId=o.ProgramId
    inner join customer with (nolock) on customer.customerId=o.customerId
    inner join Order_Line_Item oli with (nolock)  on oli.orderId=o.orderId
    inner join customer c2 with (nolock)  on c2.customerId=oli.shiptocustomerId
    inner join source with (nolock) on  source.sourceid=o.sourceid
    inner join shipmethod with (nolock) on shipmethod.shipmethodId=oli.shipmethodId
    inner join ShipCarrier with (nolock) on shipmethod.ShipCarrierId=ShipCarrier.ShipCarrierId
    INNER join Address with (nolock) on Address.AddressId=o.CustomerAddressId
    INNER join Address a2 with (nolock) on a2.AddressId=oli.ShipToAddressId
    inner join State with (nolock) on State.StateId=Address.StateId
    inner join State s2 with (nolock) on s2.StateId=a2.StateId
    inner join Country with (nolock) on Country.CountryId=Address.CountryId
    inner join Country t2 with (nolock) on t2.CountryId=a2.CountryId
    inner join Product  with (nolock) on Product.PartNumber=oli.PartNumber
    inner join Program_Product  with (nolock) on Program_Product.PartNumber=oli.PartNumber and Program_Product.programId=o.ProgramId
    Where o.orderid={0}
    order by oli.linenum


  </SQL>


  <SQL name="getDownloadOrderListFullfillment">

    Select distinct
    ShipToCustomerID ,ShipToAddressID,
    o.orderid AS order_id, o.AltOrderNum as po_num,
    1 AS release_num, c.[Company] AS b_company, a.address1 AS b_address1,
    a.[Address2] AS b_address2,
    a.[Address3] AS b_address3, a.[City] AS b_city, state.[Code] AS b_state, a.[PostalCode] AS b_zip,
    country.[ISO2] AS b_country, c.[LastName] + ', ' + c.[FirstName] AS b_contact, Phone.[Number] AS b_phone,
    o.[OrderDate] AS date_ordered,
    c.[customerId] AS cust_id, o.[TotalOrderAmount] AS total_value,
    isnull(o.[TotalShipping],0) + isnull(o.[TotalHandling],0) AS shipping_charge,
    o.[TotalTax] AS handling_charge, o.programid as group1,t.Code as group2,o.OrderTypeId,o.ForceReDownload
    ,Left(ltrim(Convert(varchar(10),o.OrderId))+' '+Program.SourceKey,25) as or_cust1,o.ExpectedShipDate as SHIP_BY_DATE
    ,t.code as ORDER_TYPE,c.AltCustNum,Order_Info.KeyValue as or_cust2
    from (
    select distinct o2.orderid, o2.altordernum, o2.programid, o2.ordertypeid, o2.customerid,
    o2.customeraddressid, o2.orderdate, o2.totaltax, o2.totalshipping,
    o2.totalhandling, o2.totalorderamount, o2.statuscode,o2.ForceReDownload, o2.ExpectedShipDate,
    oli2.ShipToCustomerID ,oli2.ShipToAddressID
    from [order] o2 with (nolock)
    inner join order_line_item oli2 with (nolock) on o2.orderid = oli2.orderid
    where oli2.releasedate is null and oli2.ReleaseNumber is null and o2.statuscode = 'AS'
    and programId={0}
    ) o
    INNER JOIN customer   c with (nolock) ON o.[CustomerId] = c.[CustomerId]
    INNER JOIN address  a with (nolock) ON o.[CustomerAddressId] = a.[AddressId]
    INNER JOIN [State] state  with (nolock)  ON a.[StateId] = state.[StateId]
    INNER JOIN country  country with (nolock) ON a.[CountryId] = country.[CountryId]
    left JOIN Phone  with (nolock) ON a.[PhoneId] = Phone.[PhoneId]
    inner join Program with (nolock) on Program.ProgramId=o.ProgramId
    inner join [Type] t with (nolock) on t.typeid=o.OrderTypeId
    left JOIN Order_Info 	with (nolock) on Order_Info.OrderId=o.OrderId and Order_Info.KeyName='O_Cust1'
    order by ShipToCustomerID ,ShipToAddressID


  </SQL>
  <SQL name="getOrderLineDownFullfillment">
    SELECT  distinct s.[Code] as ShipMethod,ShipCarrier.Code AS ShipCarrier,
    sa.AddressId as S_addressId,
    sc.[Company] AS s_company, sa.[Address1] AS s_address1, sa.[Address2] AS s_address2,
    sa.[Address3] AS s_address3, sa.[City] AS s_city, sstate.[Code] AS s_state, sa.[PostalCode] AS s_zip,
    scountry.[ISO2] AS s_country, sc.[LastName] as S_LastNAME, sc.[FirstName] AS S_FIRSTNAME,
    sc.email as s_email,
    oli.[LineNum] AS order_line, oli.[PartNumber] AS PartNumber,  oli.[Quantity] AS Quantity,
    oli.[ActualPrice] AS price, Product.Phantom
    FROM order_line_item oli
    INNER JOIN customer  sc with (nolock)  ON oli.[ShipToCustomerId] = sc.[CustomerId]
    INNER JOIN address sa with (nolock)  ON oli.[ShipToAddressId] = sa.[AddressId]
    INNER JOIN state  sstate with (nolock)  ON sa.[StateId] = sstate.[StateId]
    INNER JOIN country scountry with (nolock)  ON sa.[CountryId] = scountry.[CountryId]
    INNER JOIN [ShipMethod]  s with (nolock)  ON oli.[ShipMethodId] = s.[ShipMethodId]
    INNER JOIN dbo.ShipCarrier ON ShipCarrier.ShipCarrierId = s.ShipCarrierId
    inner join Product on Product.PartNumber=oli.PartNumber
    WHERE (oli.statuscode  &lt;&gt;'cn' or oli.statuscode is null) and oli.releasedate is null  and oli.ReleaseNumber  is null
    and oli.orderId={0}
    ORDER BY sa.AddressId

  </SQL>
  
  
</SQLDefines>
